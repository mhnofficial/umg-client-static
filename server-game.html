<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>UMG - Multiplayer</title>
Â  Â Â 
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral:wght@300;400&display=swap" rel="stylesheet">
Â  Â Â 
Â  Â  <link rel="stylesheet" href="css/main.css">
Â  Â  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
Â  Â  <link rel="stylesheet" href="css/game.css">
Â  Â  <link rel="stylesheet" href="css/modals.css">
Â  Â  
    Â  Â  <style>
    /* ... (CSS Styles remain unchanged) ... */
Â  Â  Â  Â  .online-indicator {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  width: 10px;
Â  Â  Â  Â  Â  Â  height: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #27ae60;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  Â  Â  animation: pulse 2s infinite;
Â  Â  Â  Â  }
        /* ... (rest of styles) ... */
Â  Â  </style>
</head>
<body onload="initMultiplayerConnection()">
Â  Â  <canvas id="bgCanvas"></canvas>
Â  Â  <div class="vignette"></div>

Â  Â  <div class="connection-status disconnected" id="connectionStatus">
Â  Â  Â  Â  <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e74c3c;margin-right:8px;"></span>
Â  Â  Â  Â  <span>Connecting...</span>
Â  Â  </div>

Â  Â  <div class="turn-indicator" id="turnIndicator">
Â  Â  Â  Â  YOUR TURN
Â  Â  </div>

    Â  Â  <div class="game-phase">
Â  Â  Â  Â  <div class="top-bar">
Â  Â  Â  Â  Â  Â  <div class="nation-info">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="nationNameDisplay">Your Nation</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="gameTime">Day 1 â€¢ Multiplayer</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-icon" onclick="openSettings()" title="Settings">âš™ï¸</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="game-container">
Â  Â  Â  Â  Â  Â  <div class="left-sidebar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Statistics</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="stat-label">ğŸ’° Money</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="stat-value" id="money">$5,000</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="stat-label">âš¡ Income/Turn</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="stat-value" id="income">+$500</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="server-info-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Server Info</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="server-detail">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Server Name</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="serverName">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="server-detail">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Players</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="playerCount">0/0</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="nations-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Players</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="playersList">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="empty-text">Waiting for players...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Global Chat</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-messages" id="chatMessages"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-input-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chatInput" placeholder="Send a message..." onkeypress="if(event.key==='Enter') sendGlobalChat()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="sendGlobalChat()">Send</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="game-map-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="game-map" id="gameMap">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="map-legend">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="legend-color player"></span> Your Territory</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="legend-color ally"></span> Allied</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="legend-color enemy"></span> At War</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="legend-color neutral"></span> Other Players</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="legend-color unclaimed"></span> Unclaimed</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="right-sidebar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Actions</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions-grid">
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" onclick="openModal('truceModal')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="action-icon">ğŸ•Šï¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Truce</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn" onclick="endTurn()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="action-icon">â­ï¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>End Turn</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="events-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Recent Events</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="eventLog"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="settingsModal" class="modal">
    Â  Â  </div>

Â  Â  <div id="truceModal" class="modal">
    Â  Â  </div>

    Â  Â  <script src="js/main.js"></script>
Â  Â  <script src="js/game-state.js"></script>
    
    Â  Â  <script src="js/server.js"></script>
Â  Â  <script src="js/actions/truce.js"></script>
Â  Â Â 
Â  Â  <script>
        // --- Game Setup and Utility Functions ---
Â  Â  Â  Â  const canvas = document.getElementById('bgCanvas');
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  canvas.width = window.innerWidth;
Â  Â  Â  Â  canvas.height = window.innerHeight;

Â  Â  Â  Â  const particles = [];
Â  Â  Â  Â  for(let i = 0; i < 30; i++) {
Â  Â  Â  Â  Â  Â  particles.push({
Â  Â  Â  Â  Â  Â  Â  Â  x: Math.random() * canvas.width,
Â  Â  Â  Â  Â  Â  Â  Â  y: Math.random() * canvas.height,
Â  Â  Â  Â  Â  Â  Â  Â  vx: (Math.random() - 0.5) * 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  vy: (Math.random() - 0.5) * 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  size: Math.random() * 2 + 1
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function animate() {
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(10, 10, 10, 0.1)';
Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  particles.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  p.x += p.vx;
Â  Â  Â  Â  Â  Â  Â  Â  p.y += p.vy;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
Â  Â  Â  Â  Â  Â  Â  Â  if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(244, 228, 193, 0.3)';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  requestAnimationFrame(animate);
Â  Â  Â  Â  }
Â  Â  Â  Â  animate();

        // -------------------------------------------------------------
        // FUNCTIONS USED BY server.js (Client Network Bridge)
        // -------------------------------------------------------------

Â  Â  Â  Â  // [NEW FUNCTION] Required by server.js error handler 
        // Renamed logMessage from the previous interaction to match the original structure (addChatMessage)
        window.logMessage = function(text, type = 'system') {
            const author = (type === 'chat' ? '' : 'System');
            addChatMessage(author, text, type === 'system' || type === 'error');
            
            // Basic connection status update
            const statusDiv = document.getElementById('connectionStatus');
            const statusIndicator = statusDiv.querySelector('span:first-child');
            const statusText = statusDiv.querySelector('span:last-child');
            
            if (text.includes('Connected to server successfully')) {
                statusDiv.classList.remove('disconnected');
                statusDiv.classList.add('connected');
                statusIndicator.style.background = '#27ae60';
                statusText.textContent = 'Connected';
            } else if (text.includes('Connection Error:') || text.includes('Connection failed')) {
                statusDiv.classList.remove('connected');
                statusDiv.classList.add('disconnected');
                statusIndicator.style.background = '#e74c3c';
                statusText.textContent = 'Failed';
            }
        }
        
        // [NEW FUNCTION] Placeholder for the missing function
        window.handleWelcome = function(data) {
             console.log("handleWelcome called with data:", data);
             // Logic to update initial UI from the welcome package
             
             if (data.server) {
Â  Â  Â  Â  Â  Â  Â  Â  updateServerInfo(data.server);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.player) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nationNameDisplay').textContent = data.player.name;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  logMessage(`Welcome to ${data.server ? data.server.serverName : 'the server'}!`, 'system');
        }

        // [NEW FUNCTION] Required by server.js stateUpdate
        window.updateGameState = function(newState) {
            console.log('Received state update:', newState);
            // This is where you would call updatePlayersList() and redraw the map
            // You will need to define a 'serverState' object globally for this logic to work with the functions below.
            // For now, let's assume 'serverState' is defined in js/game-state.js
            
            // Example of using the functions below (assuming serverState is populated)
            // updatePlayersList(); 
        }

        // --- Original Game Logic Functions (Now available to handleWelcome/updateGameState) ---
        
Â  Â  Â  Â  // Add chat message function
Â  Â  Â  Â  function addChatMessage(author, text, isSystem = false) {
Â  Â  Â  Â  Â  Â  const chatMessages = document.getElementById('chatMessages');
Â  Â  Â  Â  Â  Â  const msgDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  msgDiv.className = `chat-msg${isSystem ? ' system' : ''}`;
Â  Â  Â  Â  Â  Â  msgDiv.innerHTML = isSystem ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<div class="chat-text">${text}</div>` :
Â  Â  Â  Â  Â  Â  Â  Â  `<div class="chat-author">${author}</div><div class="chat-text">${text}</div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  chatMessages.appendChild(msgDiv);
Â  Â  Â  Â  Â  Â  chatMessages.scrollTop = chatMessages.scrollHeight;
Â  Â  Â  Â  }
        
        // [NEW FUNCTION] Placeholder for chat button
        function sendGlobalChat() {
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                window.sendChatMessageToNetwork(input.value.trim()); // Assumes this is defined in server.js
                input.value = '';
            }
        }
        
        // [NEW FUNCTION] Placeholder for End Turn button
        function endTurn() {
             window.sendActionToNetwork({ type: 'END_TURN' }); // Assumes this is defined in server.js
        }
        
        // [NEW FUNCTION] Placeholder for Leave Server button
        function leaveServer() {
             // Logic to disconnect socket and go back to server-pick.html
             window.location.href = 'server-pick.html'; 
        }

Â  Â  Â  Â  // Update players list
Â  Â  Â  Â  function updatePlayersList() {
            // Note: This function currently relies on a global 'serverState' object 
            // which should be populated by updateGameState or handleWelcome.
Â  Â  Â  Â  Â  Â  const playersList = document.getElementById('playersList');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!serverState.players || serverState.players.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  playersList.innerHTML = '<p class="empty-text">Waiting for players...</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  playersList.innerHTML = serverState.players.map(player => {
Â  Â  Â  Â  Â  Â  Â  Â  const isSelf = serverState.playerData && player.id === serverState.playerData.id;
Â  Â  Â  Â  Â  Â  Â  Â  const isHost = serverState.isHost && isSelf;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="online-indicator"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${player.name}${isHost ? ' ğŸ‘‘' : ''}${isSelf ? ' (You)' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-status">Online</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-score">${player.score || 0} pts</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Update server info display
Â  Â  Â  Â  function updateServerInfo(server) {
Â  Â  Â  Â  Â  Â  if (!server) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('serverName').textContent = server.serverName;
Â  Â  Â  Â  Â  Â  document.getElementById('serverHost').textContent = server.hostName;
Â  Â  Â  Â  Â  Â  document.getElementById('gameSpeed').textContent = server.gameSpeed;
Â  Â  Â  Â  Â  Â  document.getElementById('playerCount').textContent =Â 
Â  Â  Â  Â  Â  Â  Â  Â  `${server.currentPlayers}/${server.maxPlayers}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function openSettings() {
Â  Â  Â  Â  Â  Â  document.getElementById('settingsModal').classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModal(modalId) {
Â  Â  Â  Â  Â  Â  document.getElementById(modalId).classList.remove('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function openModal(modalId) {
Â  Â  Â  Â  Â  Â  document.getElementById(modalId).classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function expandLand() {
Â  Â  Â  Â  Â  Â  // Assumes sendActionToNetwork is defined in js/server.js
             window.sendActionToNetwork({ type: 'EXPAND_LAND' }); 
Â  Â  Â  Â  Â  Â  addChatMessage('System', 'Sending EXPAND_LAND action.', true);
Â  Â  Â  Â  }
        
        // Placeholder modal action
        function proposeTruce() {
            // Assumes sendActionToNetwork is defined in js/server.js
            window.sendActionToNetwork({ type: 'PROPOSE_TRUCE', targetId: document.getElementById('truceTarget').value });
            closeModal('truceModal');
        }

Â  Â  </script>
</body>
</html>
