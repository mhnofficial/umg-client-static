<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMG - Multiplayer</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral:wght@300;400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/modals.css">
    <script src=""
    
    <style>
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .player-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(138, 122, 94, 0.1);
            border-left: 3px solid #8a7a5e;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item:hover {
            background: rgba(138, 122, 94, 0.2);
            border-left-color: #f4e4c1;
        }

        .player-info {
            display: flex;
            align-items: center;
        }

        .player-name {
            color: #f4e4c1;
            font-family: 'Cinzel', serif;
            font-size: 16px;
        }

        .player-status {
            font-size: 11px;
            color: #8a7a5e;
            margin-left: 10px;
        }

        .player-score {
            color: #f1c40f;
            font-family: 'Cinzel', serif;
            font-size: 14px;
        }

        .chat-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8a7a5e;
            padding: 15px;
            box-shadow: 
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(138, 122, 94, 0.2);
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #8a7a5e;
        }

        .chat-msg {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(138, 122, 94, 0.15);
            border-left: 2px solid #8a7a5e;
        }

        .chat-msg.system {
            border-left-color: #3498db;
            font-style: italic;
            color: #3498db;
        }

        .chat-author {
            font-family: 'Cinzel', serif;
            font-size: 13px;
            color: #f4e4c1;
            margin-bottom: 3px;
        }

        .chat-text {
            font-size: 13px;
            color: #d4c4a8;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input-container input {
            flex: 1;
        }

        .chat-input-container button {
            padding: 10px 20px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #8a7a5e;
            font-family: 'Cinzel', serif;
            font-size: 12px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status.connected {
            border-color: #27ae60;
        }

        .connection-status.disconnected {
            border-color: #e74c3c;
        }

        .turn-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #f1c40f;
            font-family: 'Cinzel', serif;
            font-size: 18px;
            color: #f1c40f;
            z-index: 100;
            letter-spacing: 2px;
            display: none;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
        }

        .turn-indicator.active {
            display: block;
            animation: turnPulse 1s ease-in-out infinite;
        }

        @keyframes turnPulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(241, 196, 15, 0.5);
            }
            50% {
                box-shadow: 0 0 50px rgba(241, 196, 15, 0.8);
            }
        }

        .server-info-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8a7a5e;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(138, 122, 94, 0.2);
        }

        .server-info-panel h4 {
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #8a7a5e;
        }

        .server-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }

        .server-detail span:first-child {
            color: #8a7a5e;
        }

        .server-detail span:last-child {
            color: #f4e4c1;
        }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <div class="vignette"></div>

    <div class="connection-status disconnected" id="connectionStatus">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e74c3c;margin-right:8px;"></span>
        <span>Connecting...</span>
    </div>

    <div class="turn-indicator" id="turnIndicator">
        YOUR TURN
    </div>

    <div class="game-phase">
        <div class="top-bar">
            <div class="nation-info">
                <h2 id="nationNameDisplay">Your Nation</h2>
                <span id="gameTime">Day 1 ‚Ä¢ Multiplayer</span>
            </div>
            <button class="btn-icon" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>

        <div class="game-container">
            <div class="left-sidebar">
                <div class="stats-panel">
                    <h3>Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">üí∞ Money</span>
                        <span class="stat-value" id="money">$5,000</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üë• Population</span>
                        <span class="stat-value" id="population">10,000</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üó∫Ô∏è Territories</span>
                        <span class="stat-value" id="territories">1</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">‚öîÔ∏è Military</span>
                        <span class="stat-value" id="military">20</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ü§ù Allies</span>
                        <span class="stat-value" id="allies">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">‚ö° Income/Turn</span>
                        <span class="stat-value" id="income">+$500</span>
                    </div>
                </div>

                <div class="server-info-panel">
                    <h4>Server Info</h4>
                    <div class="server-detail">
                        <span>Server Name</span>
                        <span id="serverName">Loading...</span>
                    </div>
                    <div class="server-detail">
                        <span>Host</span>
                        <span id="serverHost">Loading...</span>
                    </div>
                    <div class="server-detail">
                        <span>Game Speed</span>
                        <span id="gameSpeed">Loading...</span>
                    </div>
                    <div class="server-detail">
                        <span>Players</span>
                        <span id="playerCount">0/0</span>
                    </div>
                </div>

                <div class="nations-panel">
                    <h3>Players</h3>
                    <div id="playersList">
                        <p class="empty-text">Waiting for players...</p>
                    </div>
                </div>

                <div class="chat-panel">
                    <h3>Global Chat</h3>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Send a message..." onkeypress="if(event.key==='Enter') sendGlobalChat()">
                        <button class="btn btn-primary" onclick="sendGlobalChat()">Send</button>
                    </div>
                </div>
            </div>

            <div class="game-map-container">
                <div class="game-map" id="gameMap">
                </div>
                
                <div class="map-legend">
                    <div><span class="legend-color player"></span> Your Territory</div>
                    <div><span class="legend-color ally"></span> Allied</div>
                    <div><span class="legend-color enemy"></span> At War</div>
                    <div><span class="legend-color neutral"></span> Other Players</div>
                    <div><span class="legend-color unclaimed"></span> Unclaimed</div>
                </div>
            </div>

            <div class="right-sidebar">
                <div class="actions-panel">
                    <h3>Actions</h3>
                    <div class="actions-grid">
                        <button class="action-btn" onclick="openModal('inventModal')">
                            <span class="action-icon">üí°</span>
                            <span>Invent</span>
                        </button>
                        <button class="action-btn" onclick="openModal('createModal')">
                            <span class="action-icon">üèóÔ∏è</span>
                            <span>Create</span>
                        </button>
                        <button class="action-btn" onclick="openModal('warModal')">
                            <span class="action-icon">‚öîÔ∏è</span>
                            <span>War</span>
                        </button>
                        <button class="action-btn" onclick="openModal('upgradeModal')">
                            <span class="action-icon">‚¨ÜÔ∏è</span>
                            <span>Upgrade</span>
                        </button>
                        <button class="action-btn" onclick="openModal('tasksModal')">
                            <span class="action-icon">üìã</span>
                            <span>Tasks</span>
                        </button>
                        <button class="action-btn" onclick="openModal('allyModal')">
                            <span class="action-icon">ü§ù</span>
                            <span>Ally</span>
                        </button>
                        <button class="action-btn" onclick="openModal('tradeModal')">
                            <span class="action-icon">üì¶</span>
                            <span>Trade</span>
                        </button>
                        <button class="action-btn" onclick="expandLand()">
                            <span class="action-icon">üó∫Ô∏è</span>
                            <span>Expand</span>
                        </button>
                        <button class="action-btn" onclick="openModal('truceModal')">
                            <span class="action-icon">üïäÔ∏è</span>
                            <span>Truce</span>
                        </button>
                        <button class="action-btn" onclick="endTurn()">
                            <span class="action-icon">‚è≠Ô∏è</span>
                            <span>End Turn</span>
                        </button>
                    </div>
                </div>

                <div class="events-panel">
                    <h3>Recent Events</h3>
                    <div id="eventLog"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('settingsModal')">&times;</span>
            <h2>‚öôÔ∏è Settings</h2>
            <div class="form-group">
                <label>Music Volume</label>
                <input type="range" id="musicVolume" min="0" max="100" value="30">
            </div>
            <div class="form-group">
                <label>Sound Effects Volume</label>
                <input type="range" id="sfxVolume" min="0" max="100" value="70">
            </div>
            <button class="btn btn-danger" onclick="leaveServer()">Leave Server</button>
        </div>
    </div>

    <div id="truceModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('truceModal')">&times;</span>
            <h2>üïäÔ∏è Propose Truce</h2>
            <div class="form-group">
                <label>Select Player</label>
                <select id="truceTarget"></select>
            </div>
            <div class="form-group">
                <label>Truce Duration</label>
                <select id="truceDuration">
                    <option value="5">5 Turns</option>
                    <option value="10">10 Turns</option>
                    <option value="20">20 Turns</option>
                    <option value="permanent">Permanent Peace</option>
                </select>
            </div>
            <div class="form-group">
                <label>Truce Terms</label>
                <textarea id="truceTerms" placeholder="Describe the terms of the truce (optional)..."></textarea>
            </div>
            <button class="btn btn-success" onclick="proposeTruce()">Propose Truce</button>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/game-state.js"></script>
    <script src="js/game-core.js"></script> 

    <script src="js/server.js"></script>
    
    <script src="js/actions/truce.js"></script>
    
    <script>
        // --- Canvas Background Animation ---
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        for(let i = 0; i < 30; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                size: Math.random() * 2 + 1
            });
        }

        function animate() {
            ctx.fillStyle = 'rgba(10, 10, 10, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                
                if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                
                ctx.fillStyle = 'rgba(244, 228, 193, 0.3)';
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            
            requestAnimationFrame(animate);
        }
        animate();

        // --- UI Helper Functions ---
        
        // Add chat message function (called by js/game-core.js)
        function addChatMessage(author, text, isSystem = false) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg${isSystem ? ' system' : ''}`;
            msgDiv.innerHTML = isSystem ? 
                `<div class="chat-text">${text}</div>` :
                `<div class="chat-author">${author}</div><div class="chat-text">${text}</div>`;
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Update players list (called by js/game-core.js)
        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            
            if (!players || Object.keys(players).length === 0) {
                playersList.innerHTML = '<p class="empty-text">Waiting for players...</p>';
                return;
            }

            playersList.innerHTML = Object.values(players).map(player => {
                const isSelf = window.playerID && player.id === window.playerID;
                const isHost = window.gameState && window.gameState.players && Object.keys(window.gameState.players)[0] === player.id;
                
                return `
                    <div class="player-item">
                        <div class="player-info">
                            <span class="online-indicator"></span>
                            <div>
                                <div class="player-name">
                                    ${player.name}${isHost ? ' üëë' : ''}${isSelf ? ' (You)' : ''}
                                </div>
                                <div class="player-status">Online</div>
                            </div>
                        </div>
                        <div class="player-score">${player.score || 0} pts</div>
                    </div>
                `;
            }).join('');
            
            // Populate truce target dropdown with available players (excluding self)
            const truceTargetSelect = document.getElementById('truceTarget');
            truceTargetSelect.innerHTML = Object.values(players)
                .filter(p => p.id !== window.playerID)
                .map(p => `<option value="${p.id}">${p.name}</option>`)
                .join('');
        }

        // Update server info display (called by js/game-core.js)
        function updateServerInfo(server) {
            if (!server) return;
            
            document.getElementById('serverName').textContent = server.serverName;
            document.getElementById('serverHost').textContent = server.hostName;
            document.getElementById('gameSpeed').textContent = server.gameSpeed;
            document.getElementById('playerCount').textContent = 
                `${server.currentPlayers}/${server.maxPlayers}`;
        }
        
        // --- Modal Control ---
        
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        // --- Full Action Implementations (No Gatekeeping) ---
        
        function endTurn() { 
            if (window.sendActionToNetwork) { 
                window.sendActionToNetwork({ type: 'END_TURN' }); 
            } else { 
                addChatMessage('System', 'Network bridge not fully loaded. Cannot end turn.', true);
            }
        }
        
        function sendGlobalChat() {
            const input = document.getElementById('chatInput');
            if (input.value.trim() && window.sendChatMessageToNetwork) {
                // Ensure the chat message is sent through the network bridge
                window.sendChatMessageToNetwork(input.value.trim());
                input.value = '';
            }
        }
        
        function proposeTruce() {
            const targetId = document.getElementById('truceTarget').value;
            const duration = document.getElementById('truceDuration').value;
            const terms = document.getElementById('truceTerms').value;

            if (!targetId) {
                addChatMessage('System', 'ERROR: Please select a player for the truce.', true);
                return;
            }

            if (window.sendActionToNetwork) {
                window.sendActionToNetwork({ 
                    type: 'PROPOSE_TRUCE', 
                    targetId: targetId,
                    duration: duration,
                    terms: terms 
                });
                addChatMessage('System', `Truce proposed to ${window.gameState.players[targetId].name} for ${duration} turns.`, true);
                closeModal('truceModal');
            }
        }

        function expandLand() {
            // This would normally open a map-based selection modal, but for a simplified action:
            if (window.sendActionToNetwork) {
                window.sendActionToNetwork({ type: 'EXPAND_LAND' });
                addChatMessage('System', 'Expansion initiated. Check the map for new territory claims.', true);
            }
        }

        // Placeholder handlers for remaining action buttons:
        
        function leaveServer() {
            // Placeholder: Simply redirects to the server list
            window.location.href = 'server-pick.html'; 
        }

        function openInventModal() {
            // Logic to populate and show technology trees
            openModal('inventModal');
            addChatMessage('System', 'Invent modal opened. Server needs to implement RESEARCH action.', true);
        }

        function openCreateModal() {
            // Logic to show unit/building creation options
            openModal('createModal');
            addChatMessage('System', 'Create modal opened. Server needs to implement CREATE action.', true);
        }

        function openWarModal() {
            // Logic to show attack/declare war options
            openModal('warModal');
            addChatMessage('System', 'War modal opened. Map click should send ATTACK action.', true);
        }

        function openUpgradeModal() {
            // Logic to show territory/unit upgrade options
            openModal('upgradeModal');
            addChatMessage('System', 'Upgrade modal opened. Server needs to implement UPGRADE action.', true);
        }

        function openTasksModal() {
            // Logic to show in-game tasks/missions
            openModal('tasksModal');
            addChatMessage('System', 'Tasks modal opened. Server needs to implement TASK_COMPLETE action.', true);
        }

        function openAllyModal() {
            // Logic to show alliance proposal options
            openModal('allyModal');
            addChatMessage('System', 'Ally modal opened. Server needs to implement PROPOSE_ALLY action.', true);
        }

        function openTradeModal() {
            // Logic to show resource trade options
            openModal('tradeModal');
            addChatMessage('System', 'Trade modal opened. Server needs to implement TRADE action.', true);
        }
    </script>
</body>
</html>
